<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTML5 GetUserMedia Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
</head>
<body>
    <input type="button" title="开启摄像头" value="开启摄像头" onclick="getMedia();" /><br />
    <video height="120px" autoplay="autoplay"></video><hr />
    <input type="button" title="拍照" value="拍照" onclick="getPhoto();" /><br />
    <canvas id="canvas1" height="120px" ></canvas><hr />
    <input type="button" title="视频" value="视频" onclick="getVedio();" /><br />
    <canvas id="canvas2" height="120px"></canvas>

    <script type="text/javascript">
        var video = document.querySelector('video');
        var audio, audioType;

        var canvas1 = document.getElementById('canvas1');
        var context1 = canvas1.getContext('2d');

        var canvas2 = document.getElementById('canvas2');
        var context2 = canvas2.getContext('2d');

        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;

        var exArray = []; //存储设备源ID
        MediaStreamTrack.getSources(function (sourceInfos) {
            for (var i = 0; i != sourceInfos.length; ++i) {
                var sourceInfo = sourceInfos[i];
                //这里会遍历audio,video，所以要加以区分
                if (sourceInfo.kind === 'video') {
                    exArray.push(sourceInfo.id);
                }
            }
        });

        function getMedia() {
            if (navigator.getUserMedia) {
                navigator.getUserMedia({
                    'video': {
                        'optional': [{
                            'sourceId': exArray[1] //0为前置摄像头，1为后置
                        }]
                    },
                    'audio':true
                }, successFunc, errorFunc);    //success是获取成功的回调函数
            }
            else {
                alert('浏览器不支持');
            }
        }

        function successFunc(stream) {
            //alert('Succeed to get media!');
            if (video.mozSrcObject !== undefined) {
                //Firefox中，video.mozSrcObject最初为null，而不是未定义的，我们可以靠这个来检测Firefox的支持
                video.mozSrcObject = stream;
            }
            else {
                video.src = window.URL && window.URL.createObjectURL(stream) || stream;
            }

            //video.play();

            // 音频
            audio = new Audio();
            audioType = getAudioType(audio);
            if (audioType) {
                audio.src = 'polaroid.' + audioType;
                audio.play();
            }
        }
        function errorFunc(e) {
            alert('Error！'+e);
        }

        
        // 将视频帧绘制到Canvas对象上,Canvas每60ms切换帧，形成肉眼视频效果
        function drawVideoAtCanvas(video,context) {
            window.setInterval(function () {
                context.drawImage(video, 0, 0,90,120);
            }, 60);
        }

        //获取音频格式
        function getAudioType(element) {
            if (element.canPlayType) {
                if (element.canPlayType('audio/mp4; codecs="mp4a.40.5"') !== '') {
                    return ('aac');
                } else if (element.canPlayType('audio/ogg; codecs="vorbis"') !== '') {
                    return ("ogg");
                }
            }
            return false;
        }

        // vedio播放时触发，绘制vedio帧图像到canvas
//        video.addEventListener('play', function () {
//            drawVideoAtCanvas(video, context2);
//        }, false);

        //拍照
        function getPhoto() {
            context1.drawImage(video, 0, 0,90,120); //将video对象内指定的区域捕捉绘制到画布上指定的区域，实现拍照。
        }

        //视频
        function getVedio() {
            drawVideoAtCanvas(video, context2);
        }

    </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"> 
<title>评论弹幕</title>
<meta name="format-detection" content="telephone=no,date=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="css/style.css">
<script src="js/jquery.min.js"></script>
<script src="js/utils.js"></script>
</head>
<body>
    <div class="feng-ccl-panel">
        <div class="abp" id="feng-player">
            <div id="commentCanvas" class="container">
                <canvas id="canvas" width="320" height="235"></canvas>
            </div>
        </div>
    </div>
    <div class="discuss">
        <p>最新评论</p>
        <ul class="discuss_ul">
        </ul>
    </div>
    <div class="footer">
        <div class="footer_box clearfix">
            <input class="input" type="text" maxlength="15">
            <a id="btn_js" class="btn" href="javascript:;">发表</a>
        </div>
    </div>
<script src="js/CommentCoreLibrary.js"></script>
<script src="js/aqu.js"></script>
<script>
window.onload = function() {
    var hiddenProperty = 'hidden' in document ? 'hidden' :    
        'webkitHidden' in document ? 'webkitHidden' :    
        'mozHidden' in document ? 'mozHidden' :    
        null;
    var visibilityChangeEvent = hiddenProperty.replace(/hidden/i, 'visibilitychange');
    var onVisibilityChange = function(){
        if (!document[hiddenProperty]) {    
            console.log('页面非激活');
            document.title = '评论弹幕';
        }else{
            console.log('页面激活');
            document.title = '看这里，看这里';
        }
    };
    document.addEventListener(visibilityChangeEvent, onVisibilityChange);
    var potyData = ['瀑布的水逆流而上','蒲公英的种子从远处飘回','聚成伞的模样','太阳从西边升起，落向东方','子弹退回枪膛','运动员回到起跑线上','我交回录取通知书','忘了十年寒窗','厨房里飘来饭菜的香','你把我的卷子签好名字','关掉电视，帮我把书包背上','你还在我身旁'];
    var linePoty = '';
    for (var i = 0; i < potyData.length; i++) {
        linePoty += '<li>'
                 +      '<div class="clearfix pdt10">'
                 +          '<p class="discuss_name fl">水墨：</p>'
                 +          '<p class="discuss_date fr">2017-2-24</p>'
                 +      '</div>'
                 +      '<p class="discuss_content">'+potyData[i]+'</p>'
                 +  '</li>';
    };
    //localStorage.removeItem('disCache');/*清除单个数据*/
    //localStorage.clear(); /*清除全部本地数据*/
    $('.discuss_ul').append(linePoty);
    var disCache = window.localStorage.getItem("disCache");
    disCache = JSON.parse(disCache);
    // console.log(disCache);
    var lineCache = '';
    if (disCache) {
        for (var i = 0; i < disCache.length; i++) {
            lineCache += '<li>'
                      +      '<div class="clearfix pdt10">'
                      +          '<p class="discuss_name fl">我：</p>'
                      +          '<p class="discuss_date fr">'+disCache[i].time+'</p>'
                      +      '</div>'
                      +      '<p class="discuss_content">'+disCache[i].content+'</p>'
                      +  '</li>';
        };
    }; 
    $('.discuss_ul').prepend(lineCache);

};
function getCmtDataList() {
    var cmtArr = [];
    // 可用ajax获取服务器的弹幕数据
    /*$.ajax({
        type : 'GET',
        url : 'data.php',
        dataType : 'json',
        data : {sid : 100},
        success : function(data) {
            cmtArr = data.dataList;

            if (cmtArr && cmtArr.length > 0) {
                sendMsg(cmtArr);
            }
        }
    });*/
    // 模拟数据
    cmtArr = [
        // {"text":"哈哈哈哈哈哈", "bgColor":"#424448"},
        // {"text":"233333", "bgColor":"#23b28b"},
        // {"text":"这是什么鬼？", "bgColor":"#424448"},
        // {"text":"一直都这么牛", "bgColor":"#3dbbc0"},
        // {"text":"来啊，互相伤害啊", "bgColor":"#ec4262"}
    ]
    // sendAllMsg(cmtArr);
}

function sendMsg(cmtArr) {

        var cmtItem = cmtArr,
            iconStr = '';
        if (cmtItem.icon && cmtItem.icon.length > 0) {
            iconStr = '<span class="icon"><img src="'+ cmtItem.icon +'"></span>';
        }

        // 字幕的节点内容
        cmtItem.text = iconStr + cmtItem.text;
        // 随机弹出方式
        cmtItem.mode = selectfrom(1,2);
        // 随机飘过的速度
        cmtItem.dur = Math.floor(Math.random()*4000 + 4000);
        CM.send(cmtItem);
}

function sendAllMsg(cmtArr) {

    for (var i=0; i<cmtArr.length; i++) {
        var cmtItem = cmtArr[i],
            iconStr = '';

        if (cmtItem.icon && cmtItem.icon.length > 0) {
            iconStr = '<span class="icon"><img src="'+ cmtItem.icon +'"></span>';
        }

        // 字幕的节点内容
        cmtItem.text = iconStr + cmtItem.text;
        cmtItem.mode = 1;
        cmtItem.dur = Math.floor(Math.random()*4000 + 4000);

        CM.send(cmtItem);
    }
}

function cmtController() {
    getCmtDataList();
    //2s读取一次
    setTimeout(function(){
        cmtController();
    }, 3000);
}

// 获取自定义区间随机数
function selectfrom(lowValue,highValue) {
    var choice = highValue - lowValue + 1;
    return Math.floor(Math.random() * choice + lowValue);
}

document.addEventListener('DOMContentLoaded', function(){
    var CM = new CommentManager(document.getElementById('commentCanvas'));
    CM.init();
    // 启动播放弹幕（在未启动状态下弹幕不会移动）
    CM.start();
    // 开放 CM 对象到全局这样就可以在 console 终端里操控
    window.CM = CM;
    // 弹幕播放
    // cmtController();
} ,false);
var cmtArr = [];
var msg;
var headimg = 'img/0.jpg';
$('#btn_js').on('click',function() {
    msg = $('.input').val().trim();
    if (msg == '') {
        alert('说点什么吧！');
    }else {
        var i = selectfrom(0,4);
        if (msg != '') {
            cmtArr[0] = {"text":msg, "bgColor":'#23b28b','icon': headimg};
            cmtArr[1] = {"text":msg, "bgColor":'#424448','icon': headimg};
            cmtArr[2] = {"text":msg, "bgColor":'#3dbbc0','icon': headimg};
            cmtArr[3] = {"text":msg, "bgColor":'#ec4262','icon': headimg};
            cmtArr[4] = {"text":msg, "bgColor":'#ec4262','icon': headimg};
            console.log(cmtArr[1]);
            sendMsg(cmtArr[i]);
        };
        var this_time = new Date();
        var theyear = this_time.getFullYear();
        var themonth = this_time.getMonth()+1;
        if (themonth < 10) {
            themonth = '0'+themonth;
        };
        var thedate = this_time.getDate();
        var line = '<li class="my">'
                 +      '<div class="clearfix pdt10">'
                 +          '<p class="discuss_name fl">我：</p>'
                 +          '<p class="discuss_date fr">'+theyear+'-'+themonth+'-'+thedate+'</p>'
                 +      '</div>'
                 +      '<p class="discuss_content">'+msg+'</p>'
                 +  '</li>';
        $('.discuss_ul').prepend(line);
        var data = [], json = {};
        $('.discuss_ul .my').each(function(){
            json = {
                content: $(this).find('.discuss_content').html(),
                time: $(this).find('.discuss_date').html()
            };
            data.push(json);
        });
        data = JSON.stringify(data);
        window.localStorage.setItem("disCache",data);
        $('.input').val('');
    };
        
});
</script>
</body>
</html> -->